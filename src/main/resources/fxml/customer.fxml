<?xml version="1.0" encoding="UTF-8"?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.geometry.Insets?>
<?import javafx.scene.shape.SVGPath?>

<StackPane xmlns="http://javafx.com/javafx"
           xmlns:fx="http://javafx.com/fxml"
           fx:controller="com.cmpe343.fx.controller.CustomerController"
           styleClass="root">

    <stylesheets>
        <java.net.URL value="@../css/base.css" />
        <java.net.URL value="@../css/customer.css" />
        <java.net.URL value="@../css/cart.css" />
    </stylesheets>

    <VBox spacing="0" styleClass="page">

        <!-- TOP BAR -->
        <HBox alignment="CENTER_LEFT" spacing="18" styleClass="topbar">
            <VBox spacing="2">
                <Label text="Group7 GreenGrocer" styleClass="brand"/>
                <Label fx:id="welcomeLabel" text="Welcome back" styleClass="muted"/>
            </VBox>

            <Region HBox.hgrow="ALWAYS"/>

            <!-- Search -->
            <HBox alignment="CENTER_LEFT" styleClass="searchbar">
                <SVGPath content="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                         styleClass="icon-muted"/>
                <TextField fx:id="searchField" promptText="Search vegetables &amp; fruits..."
                           styleClass="searchField"/>
                <Button text="Clear" onAction="#handleClearSearch" styleClass="btn-ghost"/>
            </HBox>

            <Region prefWidth="8"/>

            <!-- User -->
            <HBox alignment="CENTER" spacing="12" styleClass="userbox">
                <StackPane styleClass="avatar">
                    <Label fx:id="avatarLetter" text="U" styleClass="avatar-text"/>
                </StackPane>

                <VBox spacing="0">
                    <Label fx:id="usernameLabel" text="User" styleClass="user-name"/>
                    <Label fx:id="resultInfoLabel" text="" styleClass="muted tiny"/>
                </VBox>

                <Region prefWidth="6"/>

                <!-- Cart -->
                <StackPane onMouseClicked="#handleOpenCart" styleClass="icon-btn-wrap">
                    <Button styleClass="icon-btn" mouseTransparent="true">
                        <graphic>
                            <SVGPath content="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.54-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"
                                     styleClass="icon-white"/>
                        </graphic>
                    </Button>

                    <Label fx:id="cartCountBadge" text="0" visible="false"
                           styleClass="badge" mouseTransparent="true"
                           StackPane.alignment="TOP_RIGHT">
                        <StackPane.margin><Insets top="-6" right="-6"/></StackPane.margin>
                    </Label>
                </StackPane>

                <Button text="Log Out" onAction="#handleLogout" styleClass="btn-outline-small"/>
            </HBox>
        </HBox>

        <!-- BODY -->
        <TabPane fx:id="mainTabPane" styleClass="tab-pane" VBox.vgrow="ALWAYS">
            <tabs>
                <!-- PRODUCTS TAB -->
                <Tab text="Products" closable="false">
                    <ScrollPane fitToWidth="true" styleClass="scroll-pane" VBox.vgrow="ALWAYS">
                        <VBox spacing="18" styleClass="body">

                            <!-- HERO STRIP -->
                            <HBox alignment="CENTER_LEFT" spacing="14" styleClass="hero">
                                <VBox spacing="3">
                                    <Label text="Fresh Market" styleClass="hero-title"/>
                                    <Label text="Pick today's best vegetables &amp; fruits. Fast checkout. Live support."
                                           styleClass="hero-sub"/>
                                </VBox>
                                <Region HBox.hgrow="ALWAYS"/>
                                <StackPane styleClass="hero-pill">
                                    <Label text="✨ Seasonal Picks" styleClass="hero-pill-text"/>
                                </StackPane>
                            </HBox>

                            <!-- CATEGORY: VEGETABLES -->
                            <VBox styleClass="category-card">
                                <HBox alignment="CENTER_LEFT" spacing="12" styleClass="category-head">
                                    <StackPane styleClass="cat-icon veg">
                                        <SVGPath content="M12 2C8.69 2 6 4.69 6 8c0 1.7.7 3.23 1.83 4.32L12 22l4.17-9.68C17.3 11.23 18 9.7 18 8c0-3.31-2.69-6-6-6z"
                                                 styleClass="icon-white"/>
                                    </StackPane>
                                    <VBox spacing="0">
                                        <Label text="Vegetables" styleClass="cat-title"/>
                                        <Label fx:id="vegCountLabel" text="" styleClass="muted tiny"/>
                                    </VBox>

                                    <Region HBox.hgrow="ALWAYS"/>

                                    <Button styleClass="btn-collapse" onAction="#handleToggleVegetables">
                                        <graphic>
                                            <SVGPath fx:id="vegChevron"
                                                     content="M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"
                                                     styleClass="icon-muted"/>
                                        </graphic>
                                    </Button>
                                </HBox>

                                <VBox fx:id="vegContentBox" styleClass="category-content">
                                    <FlowPane fx:id="vegetablesGrid" hgap="18" vgap="18" prefWrapLength="1200"/>
                                </VBox>
                            </VBox>

                            <!-- CATEGORY: FRUITS -->
                            <VBox styleClass="category-card">
                                <HBox alignment="CENTER_LEFT" spacing="12" styleClass="category-head">
                                    <StackPane styleClass="cat-icon fruit">
                                        <SVGPath content="M12 2c3.86 0 7 3.14 7 7 0 5.25-7 13-7 13S5 14.25 5 9c0-3.86 3.14-7 7-7z"
                                                 styleClass="icon-white"/>
                                    </StackPane>
                                    <VBox spacing="0">
                                        <Label text="Fruits" styleClass="cat-title"/>
                                        <Label fx:id="fruitCountLabel" text="" styleClass="muted tiny"/>
                                    </VBox>

                                    <Region HBox.hgrow="ALWAYS"/>

                                    <Button styleClass="btn-collapse" onAction="#handleToggleFruits">
                                        <graphic>
                                            <SVGPath fx:id="fruitChevron"
                                                     content="M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"
                                                     styleClass="icon-muted"/>
                                        </graphic>
                                    </Button>
                                </HBox>

                                <VBox fx:id="fruitContentBox" styleClass="category-content">
                                    <FlowPane fx:id="fruitsGrid" hgap="18" vgap="18" prefWrapLength="1200"/>
                                </VBox>
                            </VBox>

                        </VBox>
                    </ScrollPane>
                </Tab>

                <!-- CART TAB -->
                <Tab text="Cart" closable="false">
                    <VBox spacing="16" style="-fx-padding: 24;" VBox.vgrow="ALWAYS">
                        <HBox alignment="CENTER_LEFT" spacing="16">
                            <Label text="Your Cart" styleClass="h1"/>
                        </HBox>

                        <ScrollPane fitToWidth="true" style="-fx-background: transparent; -fx-background-color: transparent;" VBox.vgrow="ALWAYS">
                            <VBox fx:id="cartItemsContainer" styleClass="cart-list-container"/>
                        </ScrollPane>

                        <VBox spacing="12" styleClass="cart-summary-card">
                            <Label text="Delivery Details" styleClass="h2"/>
                            <HBox spacing="12" alignment="CENTER_LEFT">
                                <DatePicker fx:id="deliveryDatePicker" promptText="Delivery Date" style="-fx-base: #1e293b;"/>
                                <TextField fx:id="deliveryTimeField" promptText="HH:mm" styleClass="field" prefWidth="100"/>
                                <Label text="Must be within 48h" styleClass="muted"/>
                            </HBox>
                            
                            <Separator style="-fx-opacity: 0.1;"/>

                            <VBox spacing="8">
                                <HBox spacing="12" alignment="CENTER_LEFT">
                                    <Label text="Coupon:" styleClass="field-label"/>
                                    <ComboBox fx:id="couponComboBox" prefWidth="200" style="-fx-base: #1e293b;"/>
                                    <Label fx:id="couponDiscountLabel" styleClass="muted" style="-fx-text-fill: #10b981;"/>
                                </HBox>
                            </VBox>

                            <Separator style="-fx-opacity: 0.1;"/>

                            <HBox spacing="24" alignment="CENTER_RIGHT">
                                <Label fx:id="totalLabel" text="Total: 0.00 ₺" styleClass="cart-total"/>
                                <Button text="Place Order" onAction="#handlePlaceOrder" styleClass="btn-primary" style="-fx-font-size: 14px; -fx-padding: 10 32 10 32;"/>
                            </HBox>
                        </VBox>
                    </VBox>
                </Tab>

                <!-- ORDERS TAB -->
                <Tab text="Orders" closable="false">
                    <VBox spacing="24" style="-fx-padding: 32;" VBox.vgrow="ALWAYS">
                        <HBox alignment="CENTER_LEFT" spacing="16">
                            <Label text="My Orders" styleClass="h2"/>
                            <Region HBox.hgrow="ALWAYS"/>
                        </HBox>

                        <ScrollPane fitToWidth="true" styleClass="scroll-pane" VBox.vgrow="ALWAYS" style="-fx-padding: 0;">
                            <VBox fx:id="ordersContainer" styleClass="list-container" spacing="12"/>
                        </ScrollPane>
                    </VBox>
                </Tab>
            </tabs>
        </TabPane>

    </VBox>

    <!-- CHAT WIDGET - Must be direct child of StackPane to be on top -->
    <VBox fx:id="chatContainer" visible="false" managed="false" maxWidth="380" maxHeight="550"
          StackPane.alignment="BOTTOM_RIGHT" styleClass="chat-window" mouseTransparent="false">
        <StackPane.margin>
            <Insets bottom="96" right="32"/>
        </StackPane.margin>

        <HBox alignment="CENTER_LEFT" spacing="10" styleClass="chat-header">
            <Label text="Live Support" styleClass="chat-title"/>
            <Region HBox.hgrow="ALWAYS"/>
            <Button onAction="#toggleChat" styleClass="btn-ghost">
                <graphic>
                    <SVGPath content="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                             styleClass="icon-muted"/>
                </graphic>
            </Button>
        </HBox>

        <ScrollPane fx:id="chatScroll" fitToWidth="true" VBox.vgrow="ALWAYS" styleClass="scroll-pane">
            <VBox fx:id="chatMessagesBox" spacing="10" style="-fx-padding: 14;"/>
        </ScrollPane>

        <HBox spacing="10" styleClass="chat-bottom">
            <TextField fx:id="chatInput" promptText="Type a message..." HBox.hgrow="ALWAYS"
                       styleClass="chat-input" onAction="#handleSendChatMessage"/>
            <Button onAction="#handleSendChatMessage" styleClass="btn-primary">
                <graphic>
                    <SVGPath content="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"
                             styleClass="icon-white"/>
                </graphic>
            </Button>
        </HBox>
    </VBox>

    <!-- Chat FAB - Must be direct child of StackPane to be on top -->
    <Button onAction="#toggleChat" styleClass="chat-fab" StackPane.alignment="BOTTOM_RIGHT">
        <StackPane.margin>
            <Insets bottom="32" right="32"/>
        </StackPane.margin>
        <graphic>
            <SVGPath content="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
                     styleClass="icon-white"/>
        </graphic>
    </Button>

</StackPane>
